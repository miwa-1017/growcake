<div class="posts-wrapper">

  <%= form_with url: search_posts_path, method: :get, local: true do %>

  <% exercise_options = {
    "有酸素" => "cardio",
    "ランニング" => "running",
    "筋トレ" => "strength",
    "ストレッチ" => "stretch",
    "ウォーキング" => "walking",
    "ヨガ" => "yoga",
    "ダンス" => "dance",
    "ピラティス" => "pilates",
    "EMS" => "ems"
    } %>

  <%= select_tag :exercise,
        options_for_select([["運動（指定なし）", ""]] + exercise_options.map { |jp, en| [jp, en] }),
        class: "form-select" %>

  <%= select_tag :cake_type,
        options_for_select([["ケーキタイプ(指定なし)", ""], ["ショートケーキ", "cake"], ["タルト", "tart"]]),
        class: "form-select" %>

  <%= select_tag :growth_status,
        options_for_select([["成長ステージ(指定なし)", ""], ["最終ステージだけ", "finished"]]),
        class: "form-select" %>

    <!-- 検索ボタン -->
    <%= submit_tag "検索", class: "btn" %>

  <% end %>

    <h2 class="posts-title">みんなの投稿</h2>

    <% if @posts.any? %>
      <!-- 投稿があるとき -->
      <div class="posts-container">
        <% @posts.each do |post| %>
          <!-- 投稿カード -->
        <% end %>
      </div>

    <% else %>
      <!-- 投稿が0件のとき（検索結果なし） -->
      <div class="empty-state">
        <%= image_tag "empty_growth_record.png", class: "empty-image" %>
        <p class="empty-text">
          条件に合う投稿は見つかりませんでした<br>
          条件を変えて探してみてください
        </p>
      </div>
    <% end %>

    <div class="posts-container">
      <% @posts.each do |post| %>
        <div class="post-card stage-<%= post.stage %>">
        <p class="post-user-name">
          <% if user_signed_in? && !current_user.guest? && post.user != current_user %>
            <%= link_to post.user.name, user_path(post.user), class: "user-link" %>
          <% else %>
            <span class="user-name-text"><%= post.user.name %></span>
          <% end %>
        </p>
        <p class="post-date">📅 <%= post.created_at.strftime("%Y/%m/%d") %></p>

        <%= link_to post_path(post), class: "post-image-link" do %>
          <% if post.image.attached? %>
            <%= image_tag "cakes/#{post.cake_type_at_post}_stage_#{format("%02d", post.stage)}.png", class: "post-card-img" %>
          <% else %>
            <%= image_tag "cakes/cake_stage_01.png", class: "post-card-img default-img" %>
          <% end %>
        <% end %>

          <div class="post-card-content">
            <p class="post-exercise">
              ✨ <%= post.exercise.present? ? post.exercise : "運動なし" %>
            </p>
            <p class="post-body"><%= truncate(post.body, length: 30) %></p>
            
          </div>

          <% if post.comments.any? %>
            <p class="comment-count">
              💬 <%= post.comments.count %>件  
              （最新：「<%= truncate(post.comments.last.content, length: 10) %>」）
            </p>
        <% else %>
            <p class="comment-count">
              💬 まだコメントはありません
            </p>
        <% end %>

          <div id="like_button_<%= post.id %>">
            <%= render "likes/like_button", post: post %>
          </div>

          <div class="post-card-actions">
            <%= link_to "詳しく見る", post_path(post), class: "card-btn" %>
          </div>
        </div>
      <% end %>
    </div>
</div>